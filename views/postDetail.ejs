<!DOCTYPE html>
<html>

<head>
    <title> QnA posts </title>
    <link rel="stylesheet" href="https://unpkg.com/mvp.css">
    <link rel="stylesheet" href="/uploads/style.css">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>

<body>
    <h1><a href="/">QnA ê²Œì‹œíŒ</a></h1>

    <div class="post-container">
        <div>
            <div class="post-header">
                <h2>
                    <%= postDetail[0].title %>
                </h2>

                <div class="button-container">
                    <% if (users && (users.user_id == postDetail[0].userId || users.role)) { %>
                        <button id="changePost" onclick="changePost(this)"
                            data-post-id="<%= postDetail[0].id %>">ìˆ˜ì •í•˜ê¸°</button>
                        <button type="submit" data-post-id="<%= postDetail[0].id %>" onclick="deletePost(this)">ì‚­ì œí•˜ê¸°</button>
                        <% } %>
                            <button id="likePost" ondblclick="likePost(this)" data-post-id="<%= postDetail[0].id %>">
                                <%= isPostGood ? 'ì¤‘ìš”í•´ìš” â˜…' : 'ì¤‘ìš”í•´ìš” â˜†' %>
                            </button>
                </div>
            </div>
            <div class="date-info">
                <p>ì¡°íšŒìˆ˜: <%= postDetail[0].views %>
                </p>
                <p>ì‘ì„± ì‹œê°„: <%= postDetail[0].created_at %>
                </p>
                <p>ìˆ˜ì • ì‹œê°„: <%= postDetail[0].updated_at %>
                </p>
                <p>ì¤‘ìš”ë„: <%= postDetail[0].important %>
                </p>
            </div>
            <p class="content">
                <%= postDetail[0].content %>
            </p>
            <div class="file-container">
                <% if (postFile.length> 0) { %>
                    <p class="attach">ğŸ”½ì²¨ë¶€íŒŒì¼</p>
                    <div class="file-items">
                        <% postFile.forEach(function(item) { %>
                            <% const pathParts=item.name.split('\\'); %>
                                <% const fileName=pathParts[pathParts.length - 1]; %>
                                    <% const extension=item.type.slice(1).toLowerCase(); %>

                                        <div class="file-item">
                                            <% if (['jpg', 'jpeg' , 'png' , 'gif' ].includes(extension)) { %>
                                                ğŸŒ‰ <a class="file-link" type="media_type"
                                                    href="/<%= item.name.replace(/\\/g, '/') %>"
                                                    download="<%= fileName %>">
                                                    <%= fileName %>
                                                </a>
                                                <% } else if (['mp4', 'mov' , 'avi' ].includes(extension)) { %>
                                                    ğŸ“¹ <a class="file-link" type="media_type"
                                                        href="/<%= item.name.replace(/\\/g, '/') %>"
                                                        download="<%= fileName %>">
                                                        <%= fileName %>
                                                    </a>
                                                    <% } else { %>
                                                        ğŸ“ <a class="file-link" type="media_type"
                                                            href="/<%= item.name.replace(/\\/g, '/') %>"
                                                            download="<%= fileName %>">
                                                            <%= fileName %>
                                                        </a>
                                                        <% } %>
                                        </div>
                                        <% }) %>
                                            <% } %>
                    </div>
            </div>
        </div>
    </div>

    <form action="/answers/<%=postDetail[0].id%>/sorted" method="post">
        <label for="sortBy">ë‹µë³€ ì •ë ¬ ê¸°ì¤€:</label>
        <select name="sortBy" id="sortBy">
            <option value="createdAt" selected>ì‘ì„± ì‹œê°„(ìµœì‹ ìˆœ)</option>
            <option value="updatedAt">ìˆ˜ì • ì‹œê°„(ìµœì‹ ìˆœ)</option>
            <option value="importance">ì¤‘ìš”ë„(ë†’ì€ìˆœ)</option>
        </select>
        <button type="submit">ê²€ìƒ‰/ì •ë ¬</button>
        <button type="button" id="addAnswer" onclick="answer(this)" data-post-id="<%= postDetail[0].id %>">ë‹µë³€ ì¶”ê°€</button>
    </form>

    <div class="answers-container">
        <% if (answers.length == 0 ) {  %>
            <h5>ì¡´ì¬í•˜ëŠ” ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤.</h5>
        <% } %>
        <% answers.forEach((answer, index)=> { %>
            <div class="answer">
                <p class="attach">No.<%= index + 1 %>
                </p>
                <div class="post-header">
                    <h3>
                        <%= answer.title %>
                    </h3>
                    <div class="button-container">
                        <% if (users && (users.user_id==answer.userId || users.role)) { %>
                            <button id="changeAnswer" onclick="changeAnswer(this)"
                                data-answer-id="<%= answer.id %>">ìˆ˜ì •í•˜ê¸°</button>
                            <button type="submit" data-answer-id="<%= answer.id %>"
                                onclick="deleteAnswer(this)">ì‚­ì œí•˜ê¸°</button>
                            <% } %>

                                <button class="likeAnswer" ondblclick="likeAnswer(this)" data-answer-id="<%= answer.id %>">
                                    <%= isAnswerGood[answer.id] ? 'ì¤‘ìš”í•´ìš” â˜…' : 'ì¤‘ìš”í•´ìš” â˜†' %>
                                </button>

                    </div>
                </div>


                <div class="date-info">
                    <p>ì¡°íšŒìˆ˜: <%= answer.views %>
                    </p>
                    <p>ì‘ì„± ì‹œê°„: <%= answer.created_at %>
                    </p>
                    <p>ìˆ˜ì • ì‹œê°„: <%= answer.updated_at %>
                    </p>
                    <p>ì¤‘ìš”ë„: <%= answer.important %>
                    </p>
                </div>
                <p class="content">
                    <%= answer.content %>
                </p>
                <div class="answer-file-container">
                    <% if (answersFile[answer.id]) { %>
                        <p class="attach">ğŸ”½ì²¨ë¶€íŒŒì¼</p>
                        <div class="file-items">
                            <% answersFile[answer.id].forEach(function(item) { %>
                                <% const pathParts=item.name.split('\\'); %>
                                    <% const fileName=pathParts[pathParts.length - 1]; %>
                                        <% const extension=item.type.slice(1).toLowerCase(); %>

                                            <div class="file-item">
                                                <% if (['jpg', 'jpeg' , 'png' , 'gif' ].includes(extension)) { %>
                                                    ğŸŒ‰ <a class="file-link" type="media_type"
                                                        href="/<%= item.name.replace(/\\/g, '/') %>"
                                                        download="<%= fileName %>">
                                                        <%= fileName %>
                                                    </a>
                                                    <% } else if (['mp4', 'mov' , 'avi' ].includes(extension)) { %>
                                                        ğŸ“¹ <a class="file-link" type="media_type"
                                                            href="/<%= item.name.replace(/\\/g, '/') %>"
                                                            download="<%= fileName %>">
                                                            <%= fileName %>
                                                        </a>
                                                        <% } else { %>
                                                            ğŸ“ <a class="file-link" type="media_type"
                                                                href="/<%= item.name.replace(/\\/g, '/') %>"
                                                                download="<%= fileName %>">
                                                                <%= fileName %>
                                                            </a>
                                                            <% } %>
                                            </div>
                                            <% }) %>
                                                <% } %>
                        </div>
                </div>
                <hr />
                <% }); %>
            </div>
    </div>


    <script>
        async function likePost(button) {
            const postId = button.getAttribute('data-post-id');

            try {
                const response = await fetch(`/posts/${postId}/like`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (response.status === 302) {
                    return window.location.href = "/users/login";
                }

                const result = await response.json();

                // ì„œë²„ì—ì„œ ë°›ì€ ì‘ë‹µì„ ê¸°ë°˜ìœ¼ë¡œ ì¢‹ì•„ìš” ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                if (result.good) {
                    button.innerText = 'ì¤‘ìš”í•´ìš” â˜…';
                } else {
                    button.innerText = 'ì¤‘ìš”í•´ìš” â˜†';
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function likeAnswer(button) {
            const answerId = button.getAttribute('data-answer-id');

            try {
                const response = await fetch(`/answers/${answerId}/like`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (response.status === 302) {
                    return window.location.href = "/users/login";
                }

                const result = await response.json();

                // ì„œë²„ì—ì„œ ë°›ì€ ì‘ë‹µì„ ê¸°ë°˜ìœ¼ë¡œ ì¢‹ì•„ìš” ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                if (result.good) {
                    button.innerText = 'ì¤‘ìš”í•´ìš” â˜…';
                } else {
                    button.innerText = 'ì¤‘ìš”í•´ìš” â˜†';
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function answer(button) {
            const postId = button.getAttribute('data-post-id');
            window.location.href = `/answers/${postId}/add`;
        }

        function changePost(button) {
            const postId = button.getAttribute('data-post-id');
            window.location.href = `/posts/${postId}/edit`;
        }

        function changeAnswer(button) {
            const answerId = button.getAttribute('data-answer-id');
            window.location.href = `/answers/${answerId}/edit`;
        }

        async function deletePost(button) {
            const postId = button.getAttribute('data-post-id');
            window.location.href = `/posts/${postId}/delete`;
        }

        async function deleteAnswer(button) {
            const answerId = button.getAttribute('data-answer-id');
            window.location.href = `/answers/${answerId}/delete`;
        }

    </script>
</body>

</html>